# Core concepts üß†

This section introduces the core building blocks of TreeRex: **subjects**, **checkers**, **flowcharts**, **decision nodes**, and **actions**.

## Subject

The **subject** is any value you pass to `FlowchartRunner::satisfies()` (an entity, DTO, array, ‚Ä¶). Your checkers decide what to do with it.

## Checker

A **checker** is any service implementing `BenTools\TreeRex\Checker\CheckerInterface`:

```php
use BenTools\TreeRex\Checker\CheckerInterface;
use BenTools\TreeRex\Runner\RunnerContext;

class MyChecker implements CheckerInterface
{
    public function satisfies(mixed $subject, mixed $criteria, RunnerContext $context): bool 
    {
        // Your logic here
        // `$subject` is what you passed to `FlowchartRunner::satisfies()`
        // `$criteria` comes from the decision node configuration.
        // `$context` is the current runner context.
        // `$context->state` is the current runner state.
        // You can change the return type hint to string or integer if this better suits your needs.
    }
}
```

The **criteria** are entirely up to you. They can be:

- simple strings (as shown in the `ProductChecker` example),
- arrays of conditions,
- arbitrary structured data (configuration objects, DTOs, ‚Ä¶),
- or expressions (when using `ExpressionLanguageChecker`).

## Flowchart

A `Flowchart` is made of:

- a global `context` (optional),
- an `entrypoint` decision node,
- other decision nodes reachable through `when@true` / `when@false` or `goto`.

You normally won't construct `Flowchart` manually ‚Äì instead, you:

- either build it from an **array** via `FlowchartFactory`,
- or from **YAML** via `FlowchartYamlFactory`.

## Decision node

A **decision node** describes:

- `checker` ‚Äì the service id (in your container) of the checker to use (can be omitted if you use `options.defaultChecker`).
- `id` ‚Äì a unique id for the node (optional; autogenerated if missing, but required for `goto`).
- `label` ‚Äì any human‚Äëfriendly label (optional).
- `criteria` ‚Äì arbitrary value passed to the checker.
- `when@true` ‚Äì what to do when the checker returns `true`.
- `when@false` ‚Äì what to do when the checker returns `false`.
- `context` ‚Äì (optional) extra context to merge when this node is evaluated.

`when@true` / `when@false` can each be:

- another decision node,
- an `end` action,
- an `error` action,
- a `goto` action,
- or omitted ("unhandled" ‚Äì see below).

## Actions

There are three explicit actions:

### `end`

Ends the flowchart and returns a boolean result.

YAML variants:

```yaml
# Short form: just a boolean result
when@true:
  end: true

# Long form: result + extra context
when@false:
  end:
    result: false
    context:
      reason: "Something went wrong"
```

### `error`

Stops the flowchart by throwing an exception.

Short form:

```yaml
when@false:
  error: "Product should never be uncategorized"
```

Long form:

```yaml
when@false:
  error:
    message: "Custom message"
    exceptionClass: "RuntimeException" # any RuntimeException subclass
    context:
      node: some_value # Optionally enrich context with more details
```

The thrown exception will have a `FlowchartRuntimeException` as its previous exception, which itself contains the `RunnerState`.

### `goto`

Jumps to another decision node by id.

> [!WARNING]
> This allows you to jump to any decision node in the flowchart.
> Be cautious when using this feature, as it can easily lead to infinite loops!

Short form:

```yaml
when@true:
  goto: some_other_node_id
```

Long form, with additional context:

```yaml
when@true:
  goto:
    id: some_other_node_id
    context:
      reason: "Jumping to another part of the flowchart"
```

If the target id cannot be found, a `FlowchartRuntimeException` is thrown.

---

‚¨ÖÔ∏è Previous: [Flowchart state & context](02-flowchart-state.md)  
‚û°Ô∏è Next: [Advanced usage](04-advanced-usage.md)
